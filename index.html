<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Interactive Map — Menu with Markets and Wells</title>
  <style>
    :root {
      --menu-bg: #ffffff;
      --menu-shadow: 0 3px 12px rgba(0,0,0,0.18);
      --btn-off: #eeeeee;
      --btn-on: #a7ffa7;
      --btn-on-text: #015701;
    }
    html, body { margin: 0; height: 100%; overflow: hidden; background: #222; font-family: Arial, sans-serif; }
    #map-container { position: relative; width: 100vw; height: 100vh; background: #222; }
    #base-map { width: 100%; height: 100%; object-fit: cover; display: block; user-select: none; -webkit-user-drag: none; pointer-events: none; }

    .marker {
      position: absolute;
      transform: translate(-50%, -50%);
      user-select: none;
      -webkit-user-drag: none;
      pointer-events: auto; /* allow native title tooltip on hover */
    }

    #menu { position: fixed; bottom: 24px; right: 24px; display: flex; flex-direction: column; gap: 10px; z-index: 1000; }
    #menu .controls { display: flex; gap: 8px; align-items: center; justify-content: flex-end; flex-wrap: wrap; }
    .btn {
      display: inline-flex; align-items: center; gap: 8px;
      font-size: 14px; font-weight: 700; background: var(--btn-off); color: #222;
      border: none; border-radius: 10px; padding: 10px 12px; cursor: pointer; outline: none;
      transition: background .2s ease; box-shadow: var(--menu-shadow);
    }
    .btn.active { background: var(--btn-on); color: var(--btn-on-text); }

    .dropdown { position: relative; }
    .dropdown-panel {
      position: absolute; bottom: 48px; right: 0; background: var(--menu-bg);
      border-radius: 14px; box-shadow: var(--menu-shadow); padding: 12px; min-width: 320px; display: none;
    }
    .dropdown-panel.open { display: block; }
    .section { display: flex; flex-direction: column; gap: 10px; }

    .tool {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 10px; border-radius: 10px; cursor: pointer;
      background: #f4f4f4; transition: background .15s ease; user-select: none;
    }
    .tool:hover { background: #e9e9e9; }
    .tool.active { background: var(--btn-on); color: var(--btn-on-text); }
    .tool .icon { width: 20px; height: 20px; pointer-events: none; }

    .collapsible { display: flex; align-items: center; justify-content: space-between; }
    .caret { font-size: 14px; opacity: 0.8; }

    .sublist { display: none; margin-top: 6px; max-height: 240px; overflow: auto; padding-right: 4px; }
    .sublist.open { display: block; }

    .subitem {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 10px; border-radius: 8px; background: #fafafa; cursor: pointer;
    }
    .subitem:hover { background: #efefef; }
    .subitem .icon { width: 18px; height: 18px; }
    .subitem.active { background: var(--btn-on); color: var(--btn-on-text); }

    #hint { position: fixed; left: 16px; bottom: 16px; color: #f5f5f5; font-size: 13px; line-height: 1.35; background: rgba(0,0,0,0.45); padding: 8px 10px; border-radius: 8px; z-index: 1000; }
    #saved { position: fixed; right: 24px; bottom: 110px; color: #fff; background: rgba(0,0,0,0.5); padding: 6px 10px; border-radius: 8px; font-size: 12px; opacity: 0; transition: opacity .25s; pointer-events: none; }
    #saved.show { opacity: 1; }
  </style>
</head>
<body>
  <div id="map-container">
    <img id="base-map" src="images/makkahs-markets-wells copy.png" alt="Map Base" />
  </div>

  <div id="menu">
    <div class="controls">
      <div class="dropdown" id="iconDropdown">
        <button class="btn" id="iconsBtn">Menu ▾</button>
        <div class="dropdown-panel" id="iconsPanel">
          <div class="section">
            <!-- Kabah -->
            <div class="tool" data-tool="kabah">
              <img class="icon" src="images/arab.png" alt="Kabah" />
              <span>Kabah</span>
            </div>

            <!-- Wells header + list -->
            <div class="tool collapsible" id="wellsHeader">
              <div style="display:flex;align-items:center;gap:8px;">
                <img class="icon" src="images/water-well.png" alt="Wells" />
                <span>Wells</span>
              </div>
              <span class="caret" id="wellsCaret">▸</span>
            </div>
            <div class="sublist" id="wellsList"></div>

            <!-- Markets header + list -->
            <div class="tool collapsible" id="marketsHeader">
              <div style="display:flex;align-items:center;gap:8px;">
                <img class="icon" src="images/market.png" alt="Markets" />
                <span>Markets</span>
              </div>
              <span class="caret" id="marketsCaret">▸</span>
            </div>
            <div class="sublist" id="marketsList"></div>

            <!-- Other trades -->
            <div class="tool" data-tool="shoemaker">
              <img class="icon" src="images/shoemaker.png" alt="Shoemaker" />
              <span>Shoemaker</span>
            </div>
            <div class="tool" data-tool="blacksmith">
              <img class="icon" src="images/blacksmith.png" alt="Blacksmith" />
              <span>Blacksmith</span>
            </div>
            <div class="tool" data-tool="butcher">
              <img class="icon" src="images/butcher.png" alt="Butchers" />
              <span>Butchers</span>
            </div>
          </div>
        </div>
      </div>

      <button class="btn" id="clearAll">Clear all</button>
      <button class="btn" id="exportBtn">Export JSON</button>
      <button class="btn" id="importBtn">Import JSON</button>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
    </div>
  </div>

  <div id="hint">Open Menu → choose Kabah; or expand Wells/Markets to choose a named item; or pick Shoemaker, Blacksmith, Butchers. Click the map to place permanently. Hover any placed icon to see its name.</div>
  <div id="saved">Saved</div>

  <script>
    const TOOL_CONFIG = {
      kabah:     { label: 'Kabah',     src: 'images/arab.png',        width: 40, height: 40, single: true },
      well:      { label: 'Wells',     src: 'images/water-well.png',  width: 32, height: 32 },
      market:    { label: 'Markets',   src: 'images/market.png',      width: 34, height: 34 },
      shoemaker: { label: 'Shoemaker', src: 'images/shoemaker.png',   width: 34, height: 34 },
      blacksmith:{ label: 'Blacksmith',src: 'images/blacksmith.png',  width: 34, height: 34 },
      butcher:   { label: 'Butchers',  src: 'images/butcher.png',     width: 34, height: 34 }
    };

    const MARKET_TYPES = [
      'Bayn al darayn',"Abu Bakr's shop",'Attarin (Perfume shops)','The layl (night) market','Slave market',
      'Mawqif al baqar','Kathib (Kayd) market','Zuqaq al nar','Bayt al azlam (House of Divination)','Qaraz (Qurt) Shops',
      'The hazwarah market','Gold and silver shops','Milk shops','Khayyatin (Tailors)','Poultry market','Al suwayqah','Grain shops'
    ];

    const WELL_TYPES = [
      'Badhdhar well','Tawa well','Huwaytib well','Rumm well','Al suwayqah well','Sajlah well',
      'Umm Jalan well','Zam zam well','Ramram (maramram) well','Al Jafr well','Al thurayya (Hafir) well',
      'Sunbulah (Ubayy) well','Umm hardan well','Al aswad well','Ajul well','Aluq well'
    ];

    const STORAGE_KEY = 'interactive-map-markers-menu-v4';

    // DOM
    const container = document.getElementById('map-container');
    const iconsBtn = document.getElementById('iconsBtn');
    const iconsPanel = document.getElementById('iconsPanel');

    const wellsHeader = document.getElementById('wellsHeader');
    const wellsCaret  = document.getElementById('wellsCaret');
    const wellsList   = document.getElementById('wellsList');

    const marketsHeader = document.getElementById('marketsHeader');
    const marketsCaret  = document.getElementById('marketsCaret');
    const marketsList   = document.getElementById('marketsList');

    const clearBtn = document.getElementById('clearAll');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');
    const savedToast = document.getElementById('saved');

    let activeTool = null;
    let activeMarketName = null;
    let activeWellName = null;

    // Build well list
    for (const name of WELL_TYPES) {
      const item = document.createElement('div');
      item.className = 'subitem';
      item.dataset.well = name;
      item.innerHTML = `<img class="icon" src="${TOOL_CONFIG.well.src}" alt="Well" /><span>${name}</span>`;
      item.addEventListener('click', () => {
        activeTool = 'well';
        activeWellName = name;
        activeMarketName = null;
        wellsList.querySelectorAll('.subitem').forEach(s => s.classList.remove('active'));
        item.classList.add('active');
        iconsPanel.classList.remove('open');
        iconsBtn.classList.remove('active');
      });
      wellsList.appendChild(item);
    }

    // Build market list
    for (const name of MARKET_TYPES) {
      const item = document.createElement('div');
      item.className = 'subitem';
      item.dataset.market = name;
      item.innerHTML = `<img class="icon" src="${TOOL_CONFIG.market.src}" alt="Market" /><span>${name}</span>`;
      item.addEventListener('click', () => {
        activeTool = 'market';
        activeMarketName = name;
        activeWellName = null;
        marketsList.querySelectorAll('.subitem').forEach(s => s.classList.remove('active'));
        item.classList.add('active');
        iconsPanel.classList.remove('open');
        iconsBtn.classList.remove('active');
      });
      marketsList.appendChild(item);
    }

    // Toggle main dropdown
    iconsBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      iconsPanel.classList.toggle('open');
      iconsBtn.classList.toggle('active');
    });
    document.addEventListener('click', (e) => {
      if (!iconsPanel.contains(e.target) && e.target !== iconsBtn) {
        iconsPanel.classList.remove('open');
        iconsBtn.classList.remove('active');
      }
    });

    // Toggle sublists
    wellsHeader.addEventListener('click', (e) => {
      e.stopPropagation();
      const open = !wellsList.classList.contains('open');
      wellsList.classList.toggle('open', open);
      wellsCaret.textContent = open ? '▾' : '▸';
      resetSelections();
    });
    marketsHeader.addEventListener('click', (e) => {
      e.stopPropagation();
      const open = !marketsList.classList.contains('open');
      marketsList.classList.toggle('open', open);
      marketsCaret.textContent = open ? '▾' : '▸';
      resetSelections();
    });

    // Activate top-level non-nested tools
    document.querySelectorAll('.tool[data-tool]').forEach(el => {
      el.addEventListener('click', () => {
        activeTool = el.dataset.tool;
        activeMarketName = null;
        activeWellName = null;
        document.querySelectorAll('.tool[data-tool]').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        wellsList.querySelectorAll('.subitem').forEach(mi => mi.classList.remove('active'));
        marketsList.querySelectorAll('.subitem').forEach(mi => mi.classList.remove('active'));
        iconsPanel.classList.remove('open');
        iconsBtn.classList.remove('active');
      });
    });

    // Place markers
    container.addEventListener('pointerdown', (e) => {
      if (!activeTool) return;
      const rect = container.getBoundingClientRect();
      const xPct = ((e.clientX - rect.left) / rect.width) * 100;
      const yPct = ((e.clientY - rect.top) / rect.height) * 100;

      if (activeTool === 'kabah') {
        const exists = container.querySelector('.marker[data-type="kabah"]');
        if (exists) return;
      }
      const marker = createMarker(activeTool, xPct, yPct, { marketName: activeMarketName, wellName: activeWellName });
      container.appendChild(marker);
      saveMarkers();
    });

    // Utilities
    clearBtn.addEventListener('click', () => {
      container.querySelectorAll('.marker').forEach(m => m.remove());
      saveMarkers();
    });
    exportBtn.addEventListener('click', () => {
      const data = readMarkers();
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'map-markers.json'; a.click();
      URL.revokeObjectURL(url);
    });
    importBtn.addEventListener('click', () => importFile.click());
    importFile.addEventListener('change', async (e) => {
      const file = e.target.files?.[0]; if (!file) return;
      try { const text = await file.text(); const data = JSON.parse(text); loadMarkers(data); saveMarkers(); }
      catch { alert('Invalid JSON'); }
      finally { importFile.value = ''; }
    });

    // Helpers
    function resetSelections() {
      activeTool = null; activeMarketName = null; activeWellName = null;
      document.querySelectorAll('.tool[data-tool]').forEach(t => t.classList.remove('active'));
      wellsList.querySelectorAll('.subitem').forEach(mi => mi.classList.remove('active'));
      marketsList.querySelectorAll('.subitem').forEach(mi => mi.classList.remove('active'));
    }

    function createMarker(type, xPct, yPct, meta = {}) {
      const cfg = TOOL_CONFIG[type];
      const el = document.createElement('img');
      el.src = cfg.src; el.alt = type; el.className = 'marker'; el.dataset.type = type;

      // Choose hover label and store metadata
      let hoverLabel = cfg.label;
      if (type === 'market' && meta.marketName) {
        el.dataset.market = meta.marketName;
        hoverLabel = meta.marketName;
      }
      if (type === 'well' && meta.wellName) {
        el.dataset.well = meta.wellName;
        hoverLabel = meta.wellName;
      }
      el.title = hoverLabel; // native tooltip on hover

      el.dataset.x = +xPct.toFixed(4);
      el.dataset.y = +yPct.toFixed(4);
      el.style.width = cfg.width + 'px';
      el.style.height = cfg.height + 'px';
      el.style.left = el.dataset.x + '%';
      el.style.top  = el.dataset.y + '%';
      return el;
    }

    function readMarkers() {
      const out = [];
      container.querySelectorAll('.marker').forEach(m => {
        out.push({
          type: m.dataset.type,
          marketName: m.dataset.market || null,
          wellName: m.dataset.well || null,
          x: parseFloat(m.dataset.x), y: parseFloat(m.dataset.y),
          w: parseInt(m.style.width), h: parseInt(m.style.height),
          src: m.getAttribute('src'),
          title: m.title
        });
      });
      return out;
    }

    function saveMarkers() {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(readMarkers())); showSavedToast(); }
      catch { console.warn('Save failed.'); }
    }

    function loadMarkers(data = null) {
      container.querySelectorAll('.marker').forEach(m => m.remove());
      if (!data) {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return; try { data = JSON.parse(raw); } catch { return; }
      }
      for (const item of data) {
        if (item.type === 'kabah' && container.querySelector('.marker[data-type="kabah"]')) continue;
        const el = createMarker(item.type, item.x, item.y, { marketName: item.marketName || null, wellName: item.wellName || null });
        if (item.w) el.style.width = item.w + 'px';
        if (item.h) el.style.height = item.h + 'px';
        if (item.src) el.src = item.src;
        if (item.title) el.title = item.title;
        container.appendChild(el);
      }
    }

    function showSavedToast() {
      const t = document.getElementById('saved');
      t.classList.add('show'); clearTimeout(showSavedToast._t);
      showSavedToast._t = setTimeout(() => t.classList.remove('show'), 600);
    }

    // Restore on load
    loadMarkers();
  </script>
</body>
</html>
