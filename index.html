<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Interactive Map — Modal Descriptions</title>
  <style>
    :root { --menu-bg:#ffffff; --menu-shadow:0 3px 12px rgba(0,0,0,0.18); --btn-off:#eeeeee; --btn-on:#a7ffa7; --btn-on-text:#015701; }
    html,body{ margin:0; height:100%; overflow:hidden; background:#222; font-family:Arial,sans-serif; }
    #map-container{ position:relative; width:100vw; height:100vh; background:#222; touch-action:manipulation; }
    #base-map{ width:100%; height:100%; object-fit:cover; display:block; user-select:none; -webkit-user-drag:none; pointer-events:none; }

    .marker{ position:absolute; transform:translate(-50%,-50%); user-select:none; -webkit-user-drag:none; pointer-events:auto; }

    #menu{ position:fixed; bottom:24px; right:24px; display:flex; flex-direction:column; gap:10px; z-index:1000; }
    #menu .controls{ display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:wrap; }
    .btn{ display:inline-flex; align-items:center; gap:8px; font-size:14px; font-weight:700; background:var(--btn-off); color:#222; border:none; border-radius:10px; padding:10px 12px; cursor:pointer; outline:none; transition:background .2s ease; box-shadow:var(--menu-shadow); }
    .btn.active{ background:var(--btn-on); color:var(--btn-on-text); }

    .dropdown{ position:relative; }
    .dropdown-panel{ position:absolute; bottom:48px; right:0; background:var(--menu-bg); border-radius:14px; box-shadow:var(--menu-shadow); padding:12px; min-width:320px; display:none; }
    .dropdown-panel.open{ display:block; }
    .section{ display:flex; flex-direction:column; gap:10px; }

    .tool{ display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px; cursor:pointer; background:#f4f4f4; transition:background .15s ease; user-select:none; }
    .tool:hover{ background:#e9e9e9; }
    .tool.active{ background:var(--btn-on); color:var(--btn-on-text); }
    .tool .icon{ width:20px; height:20px; pointer-events:none; }

    .collapsible{ display:flex; align-items:center; justify-content:space-between; }
    .caret{ font-size:14px; opacity:.8; }

    .sublist{ display:none; margin-top:6px; max-height:240px; overflow:auto; padding-right:4px; }
    .sublist.open{ display:block; }

    .subitem{ display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px; background:#fafafa; cursor:pointer; }
    .subitem:hover{ background:#efefef; }
    .subitem .icon{ width:18px; height:18px; }
    .subitem.active{ background:var(--btn-on); color:var(--btn-on-text); }

    #hint{ position:fixed; left:16px; bottom:16px; color:#f5f5f5; font-size:13px; line-height:1.35; background:rgba(0,0,0,0.45); padding:8px 10px; border-radius:8px; z-index:1000; }
    #saved{ position:fixed; right:24px; bottom:110px; color:#fff; background:rgba(0,0,0,0.5); padding:6px 10px; border-radius:8px; font-size:12px; opacity:0; transition:opacity .25s; pointer-events:none; }
    #saved.show{ opacity:1; }

    /* Modal */
    #modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.55); z-index:1500; }
    #modal.open{ display:flex; }
    #modalContent{ width:min(680px,92vw); max-height:80vh; overflow:auto; background:#0f1a24; color:#e8ecf1; border-radius:10px; box-shadow:0 12px 32px rgba(0,0,0,0.45); padding:18px 20px 20px; line-height:1.55; }
    #modalHeader{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; }
    #modalTitle{ font-size:22px; font-weight:700; letter-spacing:.2px; }
    #modalClose{ border:none; background:transparent; color:#e8ecf1; font-size:22px; cursor:pointer; padding:2px 6px; line-height:1; border-radius:6px; }
    #modalClose:hover{ background:rgba(255,255,255,0.08); }
  </style>
</head>
<body>
  <div id="map-container">
    <img id="base-map" src="images/makkahs-markets-wells copy.png" alt="Map Base"/>
  </div>

  <div id="menu">
    <div class="controls">
      <div class="dropdown" id="iconDropdown">
        <button class="btn" id="iconsBtn">Menu ▾</button>
        <div class="dropdown-panel" id="iconsPanel">
          <div class="section">
            <div class="tool" data-tool="kabah">
              <img class="icon" src="images/arab.png" alt="Kabah"/><span>Kabah</span>
            </div>

            <div class="tool collapsible" id="wellsHeader">
              <div style="display:flex;align-items:center;gap:8px;">
                <img class="icon" src="images/water-well.png" alt="Wells"/><span>Wells</span>
              </div>
              <span class="caret" id="wellsCaret">▸</span>
            </div>
            <div class="sublist" id="wellsList"></div>

            <div class="tool collapsible" id="marketsHeader">
              <div style="display:flex;align-items:center;gap:8px;">
                <img class="icon" src="images/market.png" alt="Markets"/><span>Markets</span>
              </div>
              <span class="caret" id="marketsCaret">▸</span>
            </div>
            <div class="sublist" id="marketsList"></div>

            <div class="tool" data-tool="shoemaker">
              <img class="icon" src="images/shoemaker.png" alt="Shoemaker"/><span>Shoemaker</span>
            </div>
            <div class="tool" data-tool="blacksmith">
              <img class="icon" src="images/blacksmith.png" alt="Blacksmith"/><span>Blacksmith</span>
            </div>
            <div class="tool" data-tool="butcher">
              <img class="icon" src="images/butcher.png" alt="Butchers"/><span>Butchers</span>
            </div>
          </div>
        </div>
      </div>

      <button class="btn" id="clearAll">Clear all</button>
      <button class="btn" id="exportBtn">Export JSON</button>
      <button class="btn" id="importBtn">Import JSON</button>
      <input id="importFile" type="file" accept="application/json" style="display:none"/>
    </div>
  </div>

  <div id="hint">Click any placed marker to open its description or image.</div>
  <div id="saved">Saved</div>

  <!-- Modal -->
  <div id="modal" aria-hidden="true">
    <div id="modalContent" role="dialog" aria-modal="true">
      <div id="modalHeader">
        <div id="modalTitle"></div>
        <button id="modalClose" aria-label="Close">✕</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    const TOOL_CONFIG = {
      kabah:{label:'Kabah',src:'images/arab.png',width:40,height:40,single:true},
      well:{label:'Wells',src:'images/water-well.png',width:32,height:32},
      market:{label:'Markets',src:'images/market.png',width:34,height:34},
      shoemaker:{label:'Shoemaker',src:'images/shoemaker.png',width:34,height:34},
      blacksmith:{label:'Blacksmith',src:'images/blacksmith.png',width:34,height:34},
      butcher:{label:'Butchers',src:'images/butcher.png',width:34,height:34}
    };

    const MARKET_TYPES=['Bayn al darayn',"Abu Bakr's shop",'Attarin (Perfume shops)','The layl (night) market','Slave market','Mawqif al baqar','Kathib (Kayd) market','Zuqaq al nar','Bayt al azlam (House of Divination)','Qaraz (Qurt) Shops','The hazwarah market','Gold and silver shops','Milk shops','Khayyatin (Tailors)','Poultry market','Al suwayqah','Grain shops','Sheep market'];
    const WELL_TYPES=['Badhdhar well','Tawa well','Huwaytib well','Rumm well','Al suwayqah well','Sajlah well','Umm Jalan well','Zam zam well','Ramram (maramram) well','Al Jafr well','Al thurayya (Hafir) well','Sunbulah (Ubayy) well','Umm hardan well','Al aswad well','Ajul well','Aluq well','Ajyad well','Upper (Khumm) well'];

    const STORAGE_KEY='interactive-map-markers-menu-v7';
    const MEMORY_KEY=STORAGE_KEY+':memory';
    function keyFor(type,meta={}){ if(type==='market'&&meta.marketName)return`market::${meta.marketName}`; if(type==='well'&&meta.wellName)return`well::${meta.wellName}`; return type; }
    function loadMemory(){ try{return JSON.parse(localStorage.getItem(MEMORY_KEY)||'{}');}catch{return{};} }
    function saveMemory(mem){ try{localStorage.setItem(MEMORY_KEY,JSON.stringify(mem));}catch{} }
    let placementMemory=loadMemory();

    const container=document.getElementById('map-container');
    const iconsBtn=document.getElementById('iconsBtn');
    const iconsPanel=document.getElementById('iconsPanel');
    const wellsHeader=document.getElementById('wellsHeader');
    const wellsCaret=document.getElementById('wellsCaret');
    const wellsList=document.getElementById('wellsList');
    const marketsHeader=document.getElementById('marketsHeader');
    const marketsCaret=document.getElementById('marketsCaret');
    const marketsList=document.getElementById('marketsList');
    const clearBtn=document.getElementById('clearAll');
    const exportBtn=document.getElementById('exportBtn');
    const importBtn=document.getElementById('importBtn');
    const importFile=document.getElementById('importFile');
    const savedToast=document.getElementById('saved');

    let activeTool=null, activeMarketName=null, activeWellName=null;

    // Modal
    const modal=document.getElementById('modal');
    const modalTitle=document.getElementById('modalTitle');
    const modalBody=document.getElementById('modalBody');
    const modalClose=document.getElementById('modalClose');
    function openModal(title,html){ modalTitle.textContent=title||''; modalBody.innerHTML=html||''; modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); }
    function closeModal(){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }
    modal.addEventListener('click',(e)=>{ if(e.target===modal) closeModal(); });
    modalClose.addEventListener('click',closeModal);
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeModal(); });

    // Descriptions registry (add more as needed)
    const DESC={
      'zuqaq al nar':{
        title:'Zuqāq al-Nār (South)',
        html:`<p>This “nightlife” area in Makkah’s south was where the pagans of Makkah gathered to drink alcohol and commit other sins during the pre‑Islamic Age of Ignorance.</p>`
      },
      'kathib (kayd) market':{
        title:'Kathīb (Kayd) Market',
        html:`<p>This small market was described as being at the base of Mt. Kayd (AKA: Mayghah and later Khalīfah), between Mawqif al-Baqar and a small property that belonged to a man named al-Ḥārith.</p>`
      },
      'mawqif al baqar': {
    title: 'Mawqif al-Baqar',
    html: `
      <p>Mawqif al-Baqar literally means “Cow Stand, Station, or Stop,” but may linguistically also refer to a cow lot or pen. It appears from the name that this landmark in Lower Makkah was a place where cows were sold. We also know that cows were among the sacrificial animals familiar to the residents of Makkah during the pre‑Islamic Age of Ignorance. Cattle had already been known in Arabia for many centuries, as evidenced by ancient depictions of domesticated cattle on rocks across Arabia, some of which date back to before 1000 BCE.</p>
    `},
    "abu bakr's shop": {
    title: "Abu Bakr’s Shop",
    html: `
      <p>This location is identified in sources as a shop associated with Abu Bakr. In the commercial fabric of Lower Makkah, small shops like this stood near prominent markets and thoroughfares, serving residents and pilgrims with everyday goods and trade.</p>
    `},
    'the layl (night) market': {
    title: 'The Layl (“Night”) Market',
    html: `
      <p>This was a narrow market sandwiched between a number of residential properties, with most of its shops running along the sides of the main “Belly of the Valley” flood path, and some shops actually situated on the path itself. After the time of the Prophet ﷺ, the market grew exponentially as it expanded northward along the main flood path.</p>
    `
  },
  'attarin (perfume shops)': {
    title: '‘Attārīn (Perfume Shops)',
    html: `
      <p>Makkah’s perfume shops during the time of Prophet Muḥammad ﷺ were concentrated on the property of Azhar (RA) b. ‘Abd ‘Awf of Banī Zuhrah, next to Zuqāq al-‘Attārīn, a path that acquired its name due to the presence of these shops. Another cluster of perfume shops was located close by, but across the path of Mas‘ā from Dār Azhar b. ‘Abd ‘Awf.</p>
    `
  },
  'slave market': {
    title: 'Slave Market',
    html: `
      <p>This was a seasonal market that sprang up within the Layl Market, on a small corner of land that fell on Dār al-‘Abbās b. ‘Abd al-Muṭṭalib, at the point where the path of Mas‘ā intersected with the main “Belly of the Valley” flood path.</p>
    `
  },
  'bayt al azlam (house of divination)': {
    title: 'Bayt al-Azlām (“The House of Divination”)',
    html: `
      <p>This was a place where the polytheists of Makkah would go during the pre‑Islamic Age of Ignorance to consult with mystics and soothsayers for help in deciding various issues.</p>
    `
  },
  'qaraz (qurt) shops': {
    title: 'Qaraz (Qurt) Shops',
    html: `
      <p>These shops at the southern end of the Hazwarah Market sold either qurt or qaraz (or both) near the hill known as Qarn al-Qurt. Both products consisted of extracts and other components from two types of Acacia trees.</p>
    `
  },
  'the hazwarah market': {
    title: 'The Ḥazwarah Market',
    html: `
      <p>This was the largest and most famous market inside the Valley of Makkah, where various types of merchandise, including fine fabrics, water and food containers, leather, pottery, jewelry, dates, grains, various oils, perfumes, and most other household or personal items, were sold. The Ḥazwarah Market was a popular gathering place where people would shop, but also go merely “to see and be seen.”</p>
    `
  },
  'gold and silver shops': {
    title: 'Gold & Silver Shops',
    html: `
      <p>These shops were described as being on the portion of Dār Ḥuzābah that later belonged to the family of a man named Ghazwān al-Jandī. The shops were also described as places where (gold) dīnār(s) and (silver) dirham(s) were minted, but this must have been after the time of Prophet Muḥammad ﷺ and the establishment of proper Islamic dīnār(s) and dirham(s). Prior to this, such shops would have simply sold gold and silver and checked the authentic values of foreign currencies, mostly from the Roman and Persian empires.</p>
    `
  },
  'milk shops': {
    title: 'Milk Shops',
    html: `
      <p>Several milk shops were located in this area right next to Dār Ḥuzābah, which was next to the path known as al-Ḥizāmiyyah and overlooked the main “Belly of the Valley” flood path.</p>
    `
  },
  'khayyatin (tailors)': {
    title: 'Khayyāṭīn (Tailors)',
    html: `
      <p>This area, which was part of the larger and more vibrant Ḥazwarah Market, housed the shops of the khayyāṭīn (tailors), and was explicitly described in various narrations as being directly “behind” Dār Umm Hānī’ (RA), starting in the area of her backyard.</p>
    `
  },
  'poultry market': {
    title: 'Poultry Market',
    html: `
      <p>This small market was located along a segment of the Qu‘ayqān Flood Path, within the area where the Banī Qays b. ‘Adī subclan of Bani Sahm had its homes, and is where small shops selling chickens and doves were located.</p>
    `
  },
  'grain shops': {
  title: 'Grain Shops (Hannatin)',
  html: `
    <figure style="margin:0 0 12px 0;">
      <img
        src="images/grain-shops.png"
        alt="Grain shops market scene"
        style="width:100%;height:auto;border-radius:8px;display:block;"
        loading="lazy"
      />
    </figure>
    <p>These shops specialized in staple grains for residents and travelers, with sacks and measures arranged beneath shade canopies along the market path.</p>
  `
},
'blacksmith': {
  title: 'Blacksmiths',
  html: `
    <figure style="margin:0 0 12px 0;">
      <img
    
        src="images/blacksmiths.png"
        alt="Blacksmiths area and stalls"
        style="width:100%;height:auto;border-radius:8px;display:block;"
        loading="lazy"
      />
    </figure>
    <p>Ironworking stalls equipped with bellows, anvils, hammers, and quenching basins produced tools, fittings, and arms for residents, caravans, and neighboring markets.</p>
  `
},
'shoemaker': {
title: 'Shoemakers',
        html: `
          <figure style="margin:0 0 12px 0;">
            <img src="images/Shoemakers.png"
                 alt="Shoemaker stalls and cobblers at work"
                 style="width:100%;height:auto;border-radius:8px;display:block;"
                 loading="lazy"/>
          </figure>
          <p>Leather-working booths crafting and repairing sandals and footwear for locals and pilgrims, with benches, lasts, and awls visible at the counters.</p>
        `},

'butcher': {
 title: 'Butchers',
      html: `
        <figure style="margin:0 0 12px 0;">
          <img
            src="images/Butchers.png"
            alt="Butcher market row with hanging cuts"
            style="width:100%;height:auto;border-radius:8px;display:block;"
            loading="lazy"
          />
        </figure>
        <p>Open-air meat stalls where animals were brought, dressed, and sold, with hanging cuts and scales arranged under shaded canopies.</p>
      `
    },
  'upper (khumm) well': {
  title: 'Upper (Khumm) Well',
  html: `
    <p>This well was initially dug by Qusayy b. Kilāb and later re‑excavated by his grandson ‘Abd Shams b. ‘Abd Manāf b. Qusayy. Within a few generations, however, the well apparently again fell into a state of disrepair, most likely due to the effects of flash floods that regularly ravaged the area, and so Jubayr (RA) b. Muṭ‘im b. ‘Adī (“the Elder”) b. Nawfal b. ‘Abd Manāf b. Qusayy b. Kilāb performed a major re‑excavation of the well during his time.</p>
  `
},
'aluq well': {
  title: '‘Aluq Well',
  html: `
    <p>This well, the name of which appears in some sources as “al‑Ghalūq,” belonged to the Banī ‘Abd Shams clan of the Quraysh.</p>
  `
},
'badhdhar well': {
  title: 'Badhdhar Well',
  html: `
    <p>This well was dug by Hāshim b. ‘Abd Manāf b. Quṣayy b. Kilāb, and he is the one who named it Badhdhar, which also appears in some sources as Nadhdhar and Baddar. Some narrations, however, said that the well was originally excavated by Quṣayy b. Kilāb, which may mean that Hāshim only re‑excavated it.</p>
  `
},
'tawa well': {
  title: 'Ṭawá Well',
  html: `
    <p>The Ṭawá Well was originally dug by ‘Abd Shams b. ‘Abd Manāf b. Quṣayy b. Kilāb and then later re‑dug and excavated by ‘Aqīl (RA) b. Abī Ṭālib sometime after ‘Abd al‑Muṭṭalib’s re‑excavation of Zamzam, but before the advent of Prophet Muḥammad’s prophethood ﷺ.</p>
  `
},
'huwaytib well': {
  title: 'Ḥuwayṭib Well',
  html: `
    <p>This well belonged to Ḥuwayṭib (RA) b. ‘Abd al‑‘Uzzá, and was located on the eastern perimeter of his property, on the side that faced the main “Belly of the Valley” flood path, such that the well was situated on the path itself. It was among the few wells in Makkah dug after ‘Abd al‑Muṭṭalib’s re‑excavation of Zamzam, yet before the first revelations of the Qur’ān and the advent of Prophet Muḥammad’s prophethood ﷺ.</p>
  `
},
'ajyad well': {
  title: 'Ajyād Well',
  html: `
    <p>The Ajyād Well was among the few wells dug in Makkah in the period after the well of Zamzam was excavated by ‘Abd al‑Muṭṭalib, but before the first revelations of the Qur’ān and the advent of Prophet Muḥammad’s prophethood ﷺ. It was located in the Lesser Ajyād Valley, on the property of Zuhayr b. Abī Umayyah b. al‑Mughīrah of Banī Makhzūm.</p>
  `
},
'rumm well': {
  title: 'Rumm Well',
  html: `
    <p>The Rumm Well was another well originally excavated by ‘Abd Shams b. ‘Abd Manāf, and was located on a property in Upper Makkah that was later purchased by the wealthy Khadījah (RA) bt. Khuwaylid, granting her ownership of one of the few properties in Makkah with its own private well.</p>
  `
},
'sajlah well': {
  title: 'Sajlah Well',
  html: `
    <p>This well on the Mas‘á Path was situated directly in front of Dār Jubayr b. Muṭ‘im and was also part of his property. Originally dug by Hāshim b. ‘Abd Manāf b. Quṣayy b. Kilāb, it later belonged to Jubayr’s father, Muṭ‘im b. ‘Adī b. Nawfal b. ‘Abd Manāf b. Quṣayy b. Kilāb, and then to Jubayr (RA), and as such was also known as the Well of Jubayr ibn Muṭ‘im.</p>
  `
},
'umm jalan well': {
  title: 'Umm Ja‘lān Well',
  html: `
    <p>The Well of Umm Ja‘lān was among the wells that belonged to the Banī ‘Abd Shams clan of the Quraysh.</p>
  `
},
'al suwayqah well': {
  title: 'Al‑Suwayqah Well',
  html: `
    <p>This well, which belonged to the Banī Sahm clan of the Quraysh, was not officially named the Well of al‑Suwayqah, but was instead described as “the well in al‑Suwayqah” and was also explicitly described as being on the property of Abū al‑A‘war al‑Sulamī, which was in the area of al‑Suwayqah. It is very likely that this well was the Banī Sahm Well of al‑Ghamr, the location of which was not specified in early sources.</p>
  `
},
'al jafr well': {
  title: 'Al‑Jafr Well',
  html: `
    <p>The al‑Jafr Well was dug by Umayyah b. ‘Abd Shams, and was near the entrance to the Greater Ajyād Valley, right in front of what later became the homes of Banī ‘Abd Allāh b. ‘Ikrimah b. Khālid b. ‘Ikrimah b. Khālid (RA) b. al‑‘Āṣ b. Hishām b. al‑Mughīrah of Banī Makhzūm. This al‑Jafr Well should not be confused with an earlier Jafr Well that was dug outside of Makkah by Kilāb b. Murrah prior to the Quraysh taking control over Makkah from the tribe of Khuzā‘ah under the leadership of Kilāb’s son (Quṣayy b. Kilāb).</p>
  `
},
'al thurayya (hafir) well': {
  title: 'Al‑Thurayyā (Ḥafīr) Well',
  html: `
    <p>The al‑Thurayyā Well was dug by the Banī Taym clan of the Quraysh and also became known as the Well of ‘Abd Allāh ibn Jud‘ān due to the fact that it was located on his property. The same well was also called “al‑Ḥafīr,” a term that means a well that is wide or “oversized,” and was referred to as such in a poem in which the well was metaphorically described by the clan as a “deep, raging ocean” to boast about it being a very reliable and plentiful source of water.</p>
  `
},
'sunbulah (ubayy) well': {
title: 'Sunbulah (Ubayy) Well',
html: `<p>The Well of Sunbulah was excavated by Khalaf b. Wahb of Banī Jumah, and later became known as the Ubayy Well when his son Ubayy b. Khalaf inherited the portion of his property on which the well was located. The well, which was situated in front of Ubayy’s inherited property, was further described as being on the side of his property that faced the path of al‑Ḥizāmiyyah, across the path from Dār al‑Zubayr b. al‑‘Awwām, which it was also in front of.</p>`
},
'umm hardan well': {
title: 'Umm Ḥardān Well',
html: `
<p>While it is not known who originally dug this well, it became a possession of the Banī Jumah clan of the Quraysh, and was situated next to the Banī Qurād Dam (AKA: The Banī Jumah Dam) that ‘Abd al‑Malik b. Marwān later built during his reign as caliph (65–86 AH).</p>
`
},
'al aswad well': {
title: 'Al‑Aswad Well (Shufayyah)',
html: `
<p>This well belonged to the Banī Asad b. ‘Abd al‑‘Uzzā clan of the Quraysh, and was re‑excavated or renovated after Zamzam was excavated by ‘Abd al‑Muṭṭalib, but before the first revelations of the Qur’ān and the advent of Prophet Muḥammad’s prophethood ﷺ. The well was known as the al‑Aswad Well for two reasons. The first is that it was dug by al‑Aswad b. al‑Muṭṭalib b. Asad b. ‘Abd al‑‘Uzzā, and the second is because its location was on the property that al‑Aswad b. Abī al‑Bakhtarī b. Hāshim b. al‑Ḥārith b. Asad b. ‘Abd al‑‘Uzzā inherited from his father.</p>
`
},
'ajul well': {
title: '‘Ajūl Well',
html: `
<p>The ‘Ajūl Well was a famous well located on the property of Umm Hānī’ (RA) bt. Abī Ṭālib, which had once belonged to Quṣayy b. Kilāb, who also excavated the well after he took over Makkah and united the Quraysh several generations before the time of Prophet Muḥammad ﷺ. The well eventually disappeared during expansions to al‑Masjid al‑Ḥarām undertaken by Caliph al‑Mahdī in 167 AH, when both the well and Dār Umm Hānī’ were absorbed into the area of the expanded mosque.</p>
`
},
'ramram (maramram) well': {
title: 'Ramram (Maramram) Well',
html: `
<p>Ramram was a Banī Sahm well that ceased to exist after being absorbed into the area of the mosque during expansions to al‑Masjid al‑Ḥarām undertaken by the ‘Abbāsid caliph Abū Ja‘far al‑Manṣūr in the years 137 to 140 AH, which took over some of the areas in which the Banī Sahm clan of the Quraysh had its homes (just west of the Ka‘bah).</p>
`
},
'zam zam well': {
title: 'Zamzam Well',
html: `
<p>Makkah’s most plentiful well dates back to the time of Prophet Ismā‘īl (PBUH), when his distressed mother (Hājar) ran up and down the valley between the hills of Ṣafā and Marwah in search of relief for her thirsty and dehydrated infant, whereupon the Angel Jibrīl (Gabriel) (AS) descended to reveal the waters of Zamzam.</p> <p>The famous Well of Zamzam later ran dry during the final period of Jurhumite rule over Makkah, which lasted for centuries after the time of Ismā‘īl (PBUH), and it was thus buried and forgotten. This remained the case until it was re‑excavated by the Prophet’s grandfather, ‘Abd al‑Muṭṭalib b. Hāshim.</p> <p>Once Zamzam was uncovered by ‘Abd al‑Muṭṭalib, it became the primary source of water for al‑siqāyah (providing pilgrims to Makkah with water), and two animal hide basins were placed on either side of the well and filled primarily with its water for convenience. The one on the side closest to the Ka‘bah was used for drinking, while the one on the opposite side of the well was for washing.</p>
`
}




      // Add wells and other tools here as needed, with keys matching lowercased labels
    };

    function normName(s){ return (s||'').toString().trim().toLowerCase(); }

    // Build sublists
    for(const name of WELL_TYPES){
      const item=document.createElement('div');
      item.className='subitem';
      item.dataset.well=name;
      item.innerHTML=`<img class="icon" src="${TOOL_CONFIG.well.src}" alt="Well"/><span>${name}</span>`;
      item.addEventListener('click',()=>{
        activeTool='well'; activeWellName=name; activeMarketName=null;
        wellsList.querySelectorAll('.subitem').forEach(s=>s.classList.remove('active'));
        item.classList.add('active'); iconsPanel.classList.remove('open'); iconsBtn.classList.remove('active');
        const k=keyFor('well',{wellName:name}); const rec=placementMemory[k];
        if(rec && !markerExists('well',{wellName:name})){
          const marker=createMarker('well', parseFloat(rec.x), parseFloat(rec.y), {wellName:name});
          container.appendChild(marker); saveMarkers();
        }
      });
      wellsList.appendChild(item);
    }

    for(const name of MARKET_TYPES){
      const item=document.createElement('div');
      item.className='subitem';
      item.dataset.market=name;
      item.innerHTML=`<img class="icon" src="${TOOL_CONFIG.market.src}" alt="Market"/><span>${name}</span>`;
      item.addEventListener('click',()=>{
        activeTool='market'; activeMarketName=name; activeWellName=null;
        marketsList.querySelectorAll('.subitem').forEach(s=>s.classList.remove('active'));
        item.classList.add('active'); iconsPanel.classList.remove('open'); iconsBtn.classList.remove('active');
        const k=keyFor('market',{marketName:name}); const rec=placementMemory[k];
        if(rec && !markerExists('market',{marketName:name})){
          const marker=createMarker('market', parseFloat(rec.x), parseFloat(rec.y), {marketName:name});
          container.appendChild(marker); saveMarkers();
        }
      });
      marketsList.appendChild(item);
    }

    // Menu toggles
    iconsBtn.addEventListener('click',(e)=>{ e.stopPropagation(); iconsPanel.classList.toggle('open'); iconsBtn.classList.toggle('active'); });
    document.addEventListener('click',(e)=>{ if(!iconsPanel.contains(e.target) && e.target!==iconsBtn){ iconsPanel.classList.remove('open'); iconsBtn.classList.remove('active'); } });

    wellsHeader.addEventListener('click',(e)=>{ e.stopPropagation(); const open=!wellsList.classList.contains('open'); wellsList.classList.toggle('open',open); wellsCaret.textContent=open?'▾':'▸'; resetSelections(); });
    marketsHeader.addEventListener('click',(e)=>{ e.stopPropagation(); const open=!marketsList.classList.contains('open'); marketsList.classList.toggle('open',open); marketsCaret.textContent=open?'▾':'▸'; resetSelections(); });

    document.querySelectorAll('.tool[data-tool]').forEach(el=>{
      el.addEventListener('click',()=>{
        const type=el.dataset.tool; activeTool=type; activeMarketName=null; activeWellName=null;
        document.querySelectorAll('.tool[data-tool]').forEach(t=>t.classList.remove('active'));
        el.classList.add('active');
        wellsList.querySelectorAll('.subitem').forEach(mi=>mi.classList.remove('active'));
        marketsList.querySelectorAll('.subitem').forEach(mi=>mi.classList.remove('active'));
        iconsPanel.classList.remove('open'); iconsBtn.classList.remove('active');
        const k=keyFor(type,{}); const rec=placementMemory[k];
        if(rec && !markerExists(type,{})){
          if(type==='kabah' && container.querySelector('.marker[data-type="kabah"]')) return;
          const marker=createMarker(type, parseFloat(rec.x), parseFloat(rec.y), {});
          container.appendChild(marker); saveMarkers();
        }
        // Optional: open modal for tool immediately if present in DESC
        const infoTool = DESC[normName(type)];
        if (infoTool) openModal(infoTool.title, infoTool.html);
      });
    });

    // Map click disabled
    container.addEventListener('pointerdown',()=>{});

    // Utilities
    clearBtn.addEventListener('click',()=>{ container.querySelectorAll('.marker').forEach(m=>m.remove()); saveMarkers(); });
    exportBtn.addEventListener('click',()=>{ const data=readMarkers(); const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='map-markers.json'; a.click(); URL.revokeObjectURL(url); });
    importBtn.addEventListener('click',()=>importFile.click());
    importFile.addEventListener('change',async(e)=>{ const file=e.target.files?.[0]; if(!file) return; try{ const text=await file.text(); const data=JSON.parse(text); loadMarkers(data); saveMarkers(); } catch{ alert('Invalid JSON'); } finally{ importFile.value=''; } });

    function resetSelections(){ activeTool=null; activeMarketName=null; activeWellName=null; document.querySelectorAll('.tool[data-tool]').forEach(t=>t.classList.remove('active')); wellsList.querySelectorAll('.subitem').forEach(mi=>mi.classList.remove('active')); marketsList.querySelectorAll('.subitem').forEach(mi=>mi.classList.remove('active')); }

    function markerExists(type,meta={}) {
      if(type==='market'&&meta.marketName) return !!container.querySelector(`.marker[data-type="market"][data-market="${meta.marketName}"]`);
      if(type==='well'&&meta.wellName)   return !!container.querySelector(`.marker[data-type="well"][data-well="${meta.wellName}"]`);
      return !!container.querySelector(`.marker[data-type="${type}"]`);
    }

    function createMarker(type, xPct, yPct, meta={}) {
      const cfg=TOOL_CONFIG[type];
      const el=document.createElement('img');
      el.src=cfg.src; el.alt=type; el.className='marker'; el.dataset.type=type;

      let hoverLabel=cfg.label;
      if(type==='market' && meta.marketName){ el.dataset.market=meta.marketName; hoverLabel=meta.marketName; }
      if(type==='well' && meta.wellName){ el.dataset.well=meta.wellName; hoverLabel=meta.wellName; }
      el.title=hoverLabel;

      el.dataset.x=+xPct.toFixed(4);
      el.dataset.y=+yPct.toFixed(4);
      el.style.width=cfg.width+'px';
      el.style.height=cfg.height+'px';
      el.style.left=el.dataset.x+'%';
      el.style.top=el.dataset.y+'%';

      // Click -> modal for any type present in DESC
      el.addEventListener('click',(ev)=>{
        ev.stopPropagation();
        const key =
          el.dataset.type === 'market' ? normName(el.dataset.market || '') :
          el.dataset.type === 'well'   ? normName(el.dataset.well   || '') :
          normName(el.dataset.type     || '');
        const info = DESC[key];
        if (info) openModal(info.title || el.title, info.html || '');
      });

      const memKey=keyFor(type,{marketName:el.dataset.market, wellName:el.dataset.well});
      placementMemory[memKey]={ type, x:el.dataset.x, y:el.dataset.y, marketName:el.dataset.market||null, wellName:el.dataset.well||null };
      saveMemory(placementMemory);

      return el;
    }

    function readMarkers(){
      const out=[]; container.querySelectorAll('.marker').forEach(m=>{
        out.push({ type:m.dataset.type, marketName:m.dataset.market||null, wellName:m.dataset.well||null, x:parseFloat(m.dataset.x), y:parseFloat(m.dataset.y), w:parseInt(m.style.width), h:parseInt(m.style.height), src:m.getAttribute('src'), title:m.title });
      }); return out;
    }

    function saveMarkers(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(readMarkers())); showSavedToast(); } catch{ console.warn('Save failed.'); } }
    function showSavedToast(){ const t=document.getElementById('saved'); t.classList.add('show'); clearTimeout(showSavedToast._t); showSavedToast._t=setTimeout(()=>t.classList.remove('show'),600); }

    function loadMarkers(data=null){
      container.querySelectorAll('.marker').forEach(m=>m.remove());
      if(!data){ const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return; try{ data=JSON.parse(raw); } catch{ return; } }
      for(const item of data){
        if(item.type==='kabah' && container.querySelector('.marker[data-type="kabah"]')) continue;
        const el=createMarker(item.type, item.x, item.y, {marketName:item.marketName||null, wellName:item.wellName||null});
        if(item.w) el.style.width=item.w+'px';
        if(item.h) el.style.height=item.h+'px';
        if(item.src) el.src=item.src;
        if(item.title) el.title=item.title;
        container.appendChild(el);
      }
      placementMemory={};
      container.querySelectorAll('.marker').forEach(m=>{
        const type=m.dataset.type, marketName=m.dataset.market||null, wellName=m.dataset.well||null;
        const k=keyFor(type,{marketName,wellName});
        placementMemory[k]={ type, x:m.dataset.x, y:m.dataset.y, marketName, wellName };
      });
      saveMemory(placementMemory);
    }

    loadMarkers();
  </script>
</body>
</html>
